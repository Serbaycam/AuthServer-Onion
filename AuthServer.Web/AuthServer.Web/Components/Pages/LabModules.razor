@page "/modules"
@using AuthServer.Web
@inject HttpClient Http
@rendermode InteractiveServer

<PageTitle>Test Modülleri</PageTitle>

<div class="row">
    <div class="col-md-4">
        <h3>Yeni Test Ekle</h3>
        <div class="card p-3 mb-4">
            <EditForm Model="newModule" OnValidSubmit="CreateModule" FormName="CreateModuleForm">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="mb-3">
                    <label>Test Kodu</label>
                    <InputText @bind-Value="newModule.Code" class="form-control" placeholder="Örn: ISO-105" />
                </div>

                <div class="mb-3">
                    <label>Test Adı</label>
                    <InputText @bind-Value="newModule.Name" class="form-control" placeholder="Örn: Yıkama Haslığı" />
                </div>

                <div class="mb-3">
                    <label>Açıklama</label>
                    <InputText @bind-Value="newModule.Description" class="form-control" />
                </div>

                <button type="submit" class="btn btn-primary w-100">Kaydet</button>
            </EditForm>
        </div>
    </div>

    <div class="col-md-8">
        <h3>Mevcut Testler</h3>
        @if (modules == null)
        {
            <p><em>Yükleniyor...</em></p>
        }
        else if (modules.Count == 0)
        {
            <div class="alert alert-warning">Listede hiç kayıt yok. Yandaki formu kullanarak ekleyin! 👉</div>
        }
        else
        {
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Kod</th>
                        <th>Test Adı</th>
                        <th>Açıklama</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in modules)
                    {
                        <tr>
                            <td>@item.Code</td>
                            <td>@item.Name</td>
                            <td>@item.Description</td>
                            <td>
                                <button class="btn btn-danger btn-sm" @onclick="() => DeleteModule(item.Id)">
                                    Sil 🗑️
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>
</div>

@code {
    private List<TestModuleDto>? modules;
    private CreateTestModuleRequest newModule = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadModules();
    }

    private async Task LoadModules()
    {
        // Gateway'den listeyi çek
        modules = await Http.GetFromJsonAsync<List<TestModuleDto>>("api/testmodules");
    }

    private async Task CreateModule()
    {
        // 1. Veriyi Gönder (POST)
        var response = await Http.PostAsJsonAsync("api/testmodules", newModule);

        if (response.IsSuccessStatusCode)
        {
            // 2. Formu Temizle
            newModule = new();

            // 3. Listeyi Yenile (Yeni kaydı görmek için)
            await LoadModules();
        }
        else
        {
            Console.WriteLine("Hata oluştu!");
        }
    }
    // Mevcut CreateModule metodunun altına ekle:
    private async Task DeleteModule(Guid id)
    {
        // JavaScript onayı eklemiyoruz şimdilik, direkt siliyoruz (Hız için)
        // Gateway'e DELETE isteği gönder
        var response = await Http.DeleteAsync($"api/testmodules/{id}");

        if (response.IsSuccessStatusCode)
        {
            // Listeyi yenile ki silinen satır ekrandan gitsin
            await LoadModules();
        }
        else
        {
            Console.WriteLine("Silme işlemi başarısız!");
        }
    }
}